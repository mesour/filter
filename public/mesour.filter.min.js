/* src/mesour.filter.js */
var mesour=mesour?mesour:{};mesour.filter=mesour.filter?mesour.filter:{},function(e){var r=function(){var r=this;this.VALUE_TRUE="-mesour-bool-1",this.VALUE_FALSE="-mesour-bool-0",this.VALUE_NULL="-mesour-null",this.translations={months:{1:"January",2:"February",3:"March",4:"April",5:"May",6:"June",7:"July",8:"August",9:"September",10:"October",11:"November",12:"December"},closeAll:"close all",empty:"empty","true":"true","false":"false"},this.filters={},this.create=function(){e("[data-mesour-filter]").each(function(){var t=e(this),o=t.attr("data-mesour-filter"),s=t.data("mesour-filter-instance");s||(r.filters[o]=s=new mesour.filter.Filter(o,t),t.data("mesour-filter-instance",s)),e.each(s.getDropdowns(),function(e,r){r.destroy(),r.create(),r.update(),r.getFilter().filterCheckers(),"1"===mesour.cookie(o+"-"+r.getName())&&r.open()})})}};mesour.core.createWidget("filter",new r),mesour.on.live("mesour-filter",function(){mesour.filter.create()})}(jQuery);
/* src/mesour.filter.Checkers.js */
var mesour=mesour?mesour:{};if(!mesour.filter)throw new Error("Widget "+mesour.filter+" is not created. First create mesour.filter widget.");mesour.filter.Checkers=function(e){var l=e.getElement().find(".select-all"),i=e.getElement().find(".select-all-searched"),c=e.getElement().find(".box-inner ul .checker"),s=e.getElement().find(".search-input").val(null),t=function(e,l){var i=!0;e.each(function(){$(this).is(":checked")||(i=!1)}),i?l.prop("checked",!0).closest("li").addClass("li-checked"):l.prop("checked",!1).closest("li").removeClass("li-checked")},r=function(s){i.is(":visible")&&t(c.filter(":visible"),i),t(c,l),s||(e.save(),e.getFilter().apply())},n=function(l){var i=$(this),c=i.hasClass("select-all-searched")?":visible":"";i.is(":checked")?i.closest("li").addClass("li-checked").closest("ul").find(".checker"+c).prop("checked",!0).trigger("change",!0):i.closest("li").removeClass("li-checked").closest("ul").find(".checker"+c).prop("checked",!1).trigger("change",!0),e.save(),e.getFilter().apply()},o=function(e){var l=e.closest(".toggled-sub-ul");if(l.is("*")){t(l.children("li").children(".checker"),l.closest("li").children(".checker"));var i=l.closest("li").parent("ul").closest("li");i.is("*")&&t(i.children("ul").children("li").children(".checker"),i.children(".checker"))}};e.getElement().find(".all-select-searched-li").hide(),l.off("change.data-grid"),l.on("change.data-grid",n),i.off("change.data-grid"),i.on("change.data-grid",n),c.on("change",function(e,l){var i=$(this),c=i.closest("li"),s=c.find(".toggled-sub-ul");i.is(":checked")?(c.addClass("li-checked"),s.is("*")&&s.find(".checker").prop("checked",!0).closest("li").addClass("li-checked")):(c.removeClass("li-checked"),s.is("*")&&s.find(".checker").prop("checked",!1).closest("li").removeClass("li-checked")),o(i),r(l)}),c.next("label").each(function(){var e=$(this);e.text().length>40&&e.text(e.text().substr(0,37)+"...")}),e.getElement().find(".close-all a").on("click",function(e){e.preventDefault();var l=$(this);l.closest("li").children("ul").find("ul").each(function(){var e=$(this);e.slideUp(),e.closest("li").find(".toggle-sub-ul").removeClass("glyphicon-minus").addClass("glyphicon-plus")})}),e.getElement().find(".toggle-sub-ul").on("click",function(e){e.preventDefault();var l=$(this),i=l.closest("li").children("ul"),c=l.closest("li").children(".close-all");i.is(":visible")?(i.slideUp(),c.hide(),l.removeClass("glyphicon-minus").addClass("glyphicon-plus")):(i.slideDown(),c.show(),l.removeClass("glyphicon-plus").addClass("glyphicon-minus"))}),s.off("keyup.filter-checkers"),s.on("keyup.filter-checkers",function(){var e=$(this),l=mesour.core.removeDiacritics(e.val().toLowerCase()),c=e.closest(".inline-box").next(".box-inner").find("ul .checker"),s=!1;i.closest("li").hide(),c.closest("li").show(),c.closest("li").each(function(){var e=$(this);-1===mesour.core.removeDiacritics(e.text().toLowerCase()).indexOf(l)&&(e.hide(),s=!0)}),s&&i.closest("li").show(),r(!0)}),this.getChecked=function(){var e=[];return c.filter("[data-value]").each(function(){var l=$(this);l.is(":checked")&&e.push(l.attr("data-value"))}),e},this.check=function(l){c.filter('[data-value="'+e.fixVariable(l)+'"]').prop("checked",!0).trigger("change",!0)}};
/* src/mesour.filter.CustomFilter.js */
var mesour=mesour?mesour:{};if(!mesour.filter)throw new Error("Widget "+mesour.filter+" is not created. First create mesour.filter widget.");mesour.filter.CustomFilter=function(e){var t=e.getFilter().getFilterModal(),a=function(e){return e};e.getElement().find(".mesour-open-modal").on("click",function(r){r.preventDefault();var i=$(this),l=e.getValues("custom"),f=i.attr("data-type-first"),d=i.attr("data-type-second"),n=i.attr("data-first-value"),o=i.attr("data-second-value"),u=i.attr("data-operator");if(i.hasClass("edit-filter")&&l&&(f=l.how1,d=l.how2,u=l.operator,n=l.val1,o=l.val2),t.find("[data-name]").val(e.getName()),n){var v=a(n);"string"==typeof v&&3!==v.split("-").length?(t.find(".filter-value-1").val(v),t.find(".filter-value-1").removeAttr("data-date-defaultDate")):("string"==typeof v&&3===v.split("-").length&&(v=[v]),t.find(".filter-value-1").val(v[0]),t.find(".filter-value-1").attr("data-date-defaultDate",v[0]))}else t.find(".filter-value-1").val(null);if(o){var v=a(o);"string"==typeof v?(t.find(".filter-value-2").val(v),t.find(".filter-value-2").removeAttr("data-date-defaultDate")):(t.find(".filter-value-2").val(v[0]),t.find(".filter-value-2").attr("data-date-defaultDate",v[0]))}else t.find(".filter-value-2").val(null);if(f?t.find(".filter-how-1").val(f):t.find(".filter-how-1").val(null),d?t.find(".filter-how-2").val(d):t.find(".filter-how-2").val(null),"or"===u?t.find('input[name="operator"][value=or]').prop("checked",!0):t.find('input[name="operator"][value=and]').prop("checked",!0),"date"===e.getType()){if(!$.fn.bootstrapDatetimepicker)throw new Error("jQuery.fn.bootstrapDatetimepicker is required for filter type date.");t.find(".input-group-addon").show(),t.find(".filter-datepicker1, .filter-datepicker2").data("DateTimePicker").destroy(),t.find(".filter-datepicker1, .filter-datepicker2").bootstrapDatetimepicker({pickTime:!1}),t.find(".filter-value-1, .filter-value-2").on("keydown.data-grid",function(e){e.preventDefault(),(46===e.keyCode||8===e.keyCode)&&$(this).val(null)})}else t.find(".input-group-addon").hide(),t.find(".filter-value-1, .filter-value-2").off("keydown.data-grid");$(".mesour-filter-modal").fadeIn(function(){t.find(".filter-value-1").focus()})})};
/* src/mesour.filter.Filter.js */
var mesour=mesour?mesour:{};if(!mesour.filter)throw new Error("Widget mesour.filter is not created. First create mesour.filter widget.");mesour.filter.applyFilter=function(t,e){e=$.parseJSON(e),e={filterData:e};var o=mesour.core.createLink(t,"applyFilter",e,!0);$.post(o[0],o[1]).complete(mesour.core.redrawCallback)},mesour.filter.Filter=function(t,e){var o=this,a={},r=e,i=e.attr("data-dropdown-link"),n=$('.full-reset[data-filter-name="'+t+'"]');this.apply=function(){mesour.filter.applyFilter(t,r.val())},this.getDropdowns=function(){return a},this.getName=function(){return t},this.getDropDownLink=function(){return i},this.getFilterModal=function(){return s},this.closeAll=function(o){for(var r in a)a[r].update();e.find(".dropdown").each(function(){o&&$(this)[0]===o[0]||($(this).removeClass("open"),mesour.cookie(t+"-"+$(this).attr("data-filter"),0))})};var l=$.parseJSON(r.attr("data-mesour-data"));this.getData=function(){return l},this.getPhpDateFormat=function(){return r.attr("data-mesour-date")},this.getJsDateFormat=function(){return r.attr("data-mesour-js-date")};var s=$(".mesour-filter-modal.modal-dialog");s.is("*")||(s=$('<div class="mesour-filter-modal modal-dialog"> <div class="modal-content"> <div class="modal-header"> <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button> <h4 class="modal-title">Custom filter</h4> </div> <div class="modal-body"> <form class="form-inline"> <p>Show rows where:</p> <div class="form-group"> <label class="sr-only"></label> <select class="form-control filter-how-1"> <option></option> <option value="equal_to">Equal to</option> <option value="not_equal_to">Not equal to</option> <option value="bigger">Is greater than</option> <option value="not_bigger">Is no greater than</option> <option value="smaller">Is smaller than</option> <option value="not_smaller">Is no smaller than</option> <option value="start_with">Starts with</option> <option value="not_start_with">Not starts with</option> <option value="end_with">Ends with</option> <option value="not_end_with">Not ends with</option> <option value="equal">Contains</option> <option value="not_equal">Not contains</option> </select> </div> <div class="form-group"> <label class="sr-only">Value</label> <div class="input-group date filter-datepicker1"> <input type="text" class="form-control filter-value-1" data-date-format="'+o.getJsDateFormat()+'" placeholder="Value"> <span class="input-group-addon"> <span class="glyphicon glyphicon-calendar"></span> </span> </div> </div> <br> <div class="form-group grid-operators"> <input type="radio" name="operator" class="filter-operator-and" value="and" checked="checked"> <label>and</label> <input type="radio" name="operator" class="filter-operator-or" value="or"> <label>or</label> </div> <br> <div class="form-group"> <label class="sr-only"></label> <select class="form-control filter-how-2"> <option></option> <option value="equal_to">Equal to</option> <option value="not_equal_to">Not equal to</option> <option value="bigger">Is greater than</option> <option value="not_bigger">Is no greater than</option> <option value="smaller">Is smaller than</option> <option value="not_smaller">Is no smaller than</option> <option value="start_with">Starts with</option> <option value="not_start_with">Not starts with</option> <option value="end_with">Ends with</option> <option value="not_end_with">Not ends with</option> <option value="equal">Contains</option> <option value="not_equal">Not contains</option> </select> </div> <div class="form-group"> <label class="sr-only">Value</label> <div class="input-group date filter-datepicker2"> <input type="text" class="form-control filter-value-2" data-date-format="'+o.getJsDateFormat()+'" placeholder="Value"> <span class="input-group-addon"> <span class="glyphicon glyphicon-calendar"></span> </span> </div> </div> </form> </div> <div class="modal-footer"> <button type="button" class="btn btn-primary btn-sm save-custom-filter">Ok</button> <button type="button" class="btn btn-danger btn-sm" data-dismiss="modal">Storno</button> </div> <input type="hidden" data-name=""> </div> <!-- /.modal-content --> </div> <!-- /.modal-dialog -->'),$("body").append(s),s.find('[aria-hidden="true"], [data-dismiss="modal"]').on("click.custom-filter",function(t){t.preventDefault(),$(this).closest(".modal-dialog").fadeOut()}),s.find(".save-custom-filter").on("click",function(){var t=s.find("[data-name]").val(),e={how1:s.find(".filter-how-1").val(),how2:s.find(".filter-how-2").val(),val1:s.find(".filter-value-1").val(),val2:s.find(".filter-value-2").val(),operator:s.find('input[name="operator"]:checked').val()};return 0===e.how1.length?(alert("Please select some value in first select."),void s.find(".filter-how-1").focus()):0===e.val1.length?(alert("Please insert some value for first text input."),void s.find(".filter-value-1").focus()):0!==e.how2.length&&0===e.val2.length?(alert("Please insert some value for second input."),void s.find(".filter-value-2").focus()):(a[t].setValues(e,"custom"),a[t].setValues("date"!==a[t].getType()?"text":"date","type"),$(this).closest(".modal-dialog").fadeOut(),a[t].update(),a[t].save(),void a[t].getFilter().apply())})),this.getValues=function(t){var e=r.val();return e=0===e.length?{}:$.parseJSON(e),t?e[t]?e[t]:{}:e},this.setValues=function(t,e){var o=r.val().length>0?$.parseJSON(r.val()):{};o[e]=t,r.val(JSON.stringify(o))},this.refreshPriorities=function(){var t=o.getValues(),e={};for(var a in t)e[t[a].priority]=a;var i=[];for(var n in e)e.hasOwnProperty(n)&&i.push(n);i.sort();for(var l=1,s=0;s<i.length;s++)n=i[s],t[e[n]].priority&&(t[e[n]].priority=l,l++);r.val(JSON.stringify(t))},this.generateNextPriority=function(){o.refreshPriorities();var t=o.getValues(),e=[];for(var a in t)e.push(t[a].priority);if(e.length>0){for(var r=1,i=0;i<e.length;i++)e[i]>r?r=e[i]+1:e[i]===r&&r++;return r}return 1},this.filterData=function(t,e){var a=o.getData(),r=[];for(var i in a)-1!==e.indexOf(a[i][t])&&r.push(a[i]);return r},this.filterCheckers=function(){var t=o.getValues(),e={};for(var r in t)e[t[r].priority]=r;var i=[];for(var n in e)e.hasOwnProperty(n)&&i.push(n);i.sort();for(var l={},s=o.getData(),u=0;u<i.length;u++)n=i[u],l[e[n]]=!0,a[e[n]].destroy(),a[e[n]].create(s,!0),a[e[n]].update(),t[e[n]].checkers&&t[e[n]].checkers.length>0&&(s=o.filterData(e[n],t[e[n]].checkers));for(var r in a){var p=a[r];l[p.getName()]||(a[r].destroy(),a[r].create(s,!0),a[r].update())}},n.on("click",function(t){t.preventDefault(),$.each(o.getDropdowns(),function(t,e){e.unsetValues("custom"),e.unsetValues("priority"),e.unsetValues("checkers"),e.update(),e.getFilter().filterCheckers()}),o.apply()}),$('.dropdown[data-filter-name="'+t+'"]').each(function(){var t=$(this),e=t.attr("data-filter");a[e]=new mesour.filter.DropDown(t,e,o),t.data("grid-filter-dropdown",a[e])}),o.filterCheckers(),$.fn.bootstrapDatetimepicker&&$(".filter-datepicker1, .filter-datepicker2").bootstrapDatetimepicker({pickTime:!1})};
/* src/mesour.filter.DropDown.js */
var mesour=mesour?mesour:{};if(!mesour.filter)throw new Error("Widget "+mesour.filter+" is not created. First create mesour.filter widget.");mesour.filter.applyDropDown=function(e,n,t){if(""!==t){var s=t.id,a=t.opened;mesour.cookie(e+"-"+s,a)}},mesour.filter.DropDown=function(e,n,t){var s=this,a=function(e){return null===e?mesour.filter.VALUE_NULL:e===!0?mesour.filter.VALUE_TRUE:e===!1?mesour.filter.VALUE_FALSE:e};this.fixVariable=function(e){return a(e)},this.translateVariable=function(e){return null===e?"<i>"+mesour.filter.translations.empty+"</i>":e===!0?"<i>"+mesour.filter.translations["true"]+"</i>":e===!1?"<i>"+mesour.filter.translations["false"]+"</i>":e};var r,o,l=e.attr("data-type"),i=!1,u=function(){},p=function(){var n=e.find(".box-inner").find("ul");n.find("li:not(.all-select-li):not(.all-select-searched-li)").remove()};this.destroy=function(){p()},this.create=function(e,n){u(e,n)};var c=function(e){mesour.filter.applyDropDown(t.getName(),t.getDropDownLink(),e)};u=function(r,i){if(r=r?r:t.getData()){for(var u={},p=0;p<r.length;p++){if("undefined"==typeof r[p][n])throw new Error('MesourFilterDropDownException: Column "'+n+'" does not exists in data.');u[r[p][n]]?u[r[p][n]].keys.push(p):u[a(r[p][n])]={val:a(r[p][n]),translated:s.translateVariable(r[p][n]),keys:[p]}}if(l){if("date"===l){var c=[],d={},f={};for(var h in u)if(u[h].val){var v=isNaN(u[h].val);u[h].val&&(u[h].val===mesour.filter.VALUE_NULL||u[h].val===mesour.filter.VALUE_TRUE||u[h].val===mesour.filter.VALUE_FALSE)&&(f[u[h]]=u[h]);var m=v?mesour.core.strtotime(u[h].val):u[h].val,g=mesour.core.phpDate("Y",m),b=mesour.core.phpDate("n",m),y=mesour.core.phpDate("j",m);-1===c.indexOf(g)&&c.push(g),d[g]||(d[g]={},d[g].months=[],d[g].days={}),-1===d[g].months.indexOf(b)&&d[g].months.push(b),d[g].days[b]||(d[g].days[b]=[]),-1===d[g].days[b].indexOf(y)&&d[g].days[b].push(y)}c.sort(function(e,n){return n-e});var k=e.find(".box-inner").find("ul");for(var V in f)if(f.hasOwnProperty(V)){var w=$("<li>"),D=n+(f[V].val&&"function"==typeof f[V].val.replace?f[V].val.replace(" ",""):f[V].val);w.append('<input type="checkbox" class="checker" data-value="'+f[V].val+'" id="'+D+'">'),w.append("&nbsp;"),w.append('<label for="'+D+'">'+f[V].translated+"</label>"),k.append(w)}for(var x in c)if(c.hasOwnProperty(x)){var C=$("<li>");C.append('<span class="glyphicon glyphicon-plus toggle-sub-ul"></span>'),C.append("&nbsp;"),C.append('<input type="checkbox" class="checker">'),C.append("&nbsp;"),C.append("<label>"+c[x]+"</label>"),C.append('<span class="close-all">(<a href="#">Close all</a>)</span>');var E=$('<ul class="toggled-sub-ul">');C.append(E),d[c[x]].months.sort(function(e,n){return e-n});var b=d[c[x]].months;for(var L in b){var A=$("<li>");A.append('<span class="glyphicon glyphicon-plus toggle-sub-ul"></span>'),A.append("&nbsp;"),A.append('<input type="checkbox" class="checker">'),A.append("&nbsp;"),A.append("<label>"+mesour.filter.translations.months[b[L]]+"</label>"),E.append(A);var N=$('<ul class="toggled-sub-ul">');A.append(N),d[c[x]].days[b[L]].sort(function(e,n){return e-n});var U=d[c[x]].days[b[L]];for(var F in U){var O=mesour.core.strtotime(c[x]+"-"+b[L]+"-"+U[F]),_=v?mesour.core.phpDate(t.getPhpDateFormat(),O):O,P=$("<li>");P.append('<span class="glyphicon">&nbsp;</span>'),P.append('<input type="checkbox" class="checker" data-value="'+_+'">'),P.append("&nbsp;"),P.append("<label>"+U[F]+"</label>"),N.append(P)}}k.append(C)}}}else{var k=e.find(".box-inner").find("ul");for(var h in u)if(u[h].val||0===Number(u[h].val)){var w=$("<li>"),D=n+(u[h].val&&"function"==typeof u[h].val.replace?u[h].val.replace(" ",""):u[h].val);w.append('<input type="checkbox" class="checker" data-value="'+u[h].val+'" id="'+D+'">'),w.append("&nbsp;"),w.append('<label for="'+D+'">'+u[h].translated+"</label>"),k.append(w)}}i&&(o=new mesour.filter.Checkers(s))}},u(),this.getName=function(){return n},this.getType=function(){return l?l:"text"},this.getElement=function(){return e},this.getValues=function(e){var s=t.getValues(n);return e?s[e]?s[e]:{}:s},this.setValues=function(e,s){var a=t.getValues(n);a[s]=e,t.setValues(a,n)},this.unsetValues=function(e){var s=t.getValues(n);delete s[e],t.setValues(s,n)},this.getFilter=function(){return t},r=new mesour.filter.CustomFilter(this),o=new mesour.filter.Checkers(this),this.update=function(){var n=s.getValues(),t=e.find(".dropdown-toggle"),a=e.find(".dropdown-menu"),r=a.children(".dropdown-submenu");if(t.find(".glyphicon-ok").hide(),r.find(".glyphicon").closest("button").hide(),e.removeClass("active-item").removeClass("active-checkers"),n&&(n.custom&&n.custom.operator&&(t.find(".glyphicon-ok").show(),e.addClass("active-item"),r.find(".glyphicon").closest("button").show()),n.checkers&&"undefined"!=typeof n.checkers[0])){t.find(".glyphicon-ok").show(),e.addClass("active-checkers");for(var l=0;l<n.checkers.length;l++)o.check(n.checkers[l])}},this.toggle=function(){s.isOpened()?s.close():s.open()},this.isOpened=function(){return e.hasClass("open")},this.open=function(){t.closeAll(e),e.addClass("open"),c({id:s.getName(),opened:1})},this.close=function(){s.update(),e.removeClass("open"),c({id:s.getName(),opened:0})},e.on({mouseenter:function(){i=!0},mouseleave:function(){i=!1}}),$(".mesour-filter-modal").on({mouseenter:function(){i=!0},mouseleave:function(){i=!1}}),$("html").on("click.filter-el-"+n,function(){s.isOpened()&&!i&&s.close()}),e.children("button").on("click",function(n){n.preventDefault(),t.closeAll(e),s.toggle(e)}),e.find(".reset-filter").on({click:function(){s.unsetValues("custom"),s.update(),s.save(),t.apply()},mouseenter:function(){$(this).removeClass("btn-success").addClass("btn-danger")},mouseleave:function(){$(this).removeClass("btn-danger").addClass("btn-success")}}),e.find(".close-filter").on("click",function(e){e.preventDefault(),s.update(),s.close()}),this.save=function(){var e=o.getChecked();e.length>0?(s.setValues(s.getFilter().generateNextPriority(),"priority"),s.setValues(e,"checkers"),s.setValues("date"!==l?"text":"date","type")):(s.unsetValues("priority"),s.unsetValues("checkers"))},this.update()};
